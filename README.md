# 家計分担 for MoneyForward

家計分担 for MoneyForwardは、MoneyForwardの家計簿ページを開くと自動的に経費を計算し、パートナーとの負担割合を計算するChrome拡張機能です。

## 機能

- MoneyForwardの家計簿ページから自動的に取引データを抽出
- 設定した割合に基づいてパートナーとの経費分担を計算
- 計算結果をMoneyForwardページ上に表示
- パートナーの支払い状況と不足額を一目で確認
- **Google スプレッドシート連携**: 計算結果を月ごとにスプレッドシートに保存

## インストール方法

### 開発版をインストール

1. このリポジトリをクローンまたはダウンロードします
2. `npm install` を実行して依存関係をインストールします
3. `npm run build` を実行して拡張機能をビルドします
4. Chromeで `chrome://extensions/` を開きます
5. 右上の「デベロッパーモード」をオンにします
6. 「パッケージ化されていない拡張機能を読み込む」をクリックします
7. ビルドされた `dist` ディレクトリを選択します

## 使い方

1. [MoneyForwardの家計簿ページ](https://moneyforward.com/cf)を開きます
2. 拡張機能が自動的に取引データを抽出し、計算を行います
3. 計算結果がページの右上に表示されます
4. Chrome拡張機能のアイコンをクリックすると、詳細な結果と設定画面が表示されます

### 計算結果の見方

- **経費合計**: 計算対象となる取引の合計金額
- **パートナー支払い**: パートナーが支払うべき金額（設定した割合に基づく）
- **パートナー持ち出し**: パートナーの口座から実際に支払われた金額
- **パートナー不足**: パートナーが追加で支払うべき金額

## 設定方法

拡張機能のポップアップで「設定」タブを選択すると、以下の設定が可能です：

### 基本設定

- **割合設定**: パートナーの負担割合（0〜1の数値、例: 0.5 = 50%）
- **パートナー名**: 表示に使用するパートナーの名前

### 詳細設定

- **経費大項目設定**: 計算から除外する大項目カテゴリ
- **経費中項目設定**: 計算から除外する中項目カテゴリ
- **パートナー金融機関設定**: パートナーの金融機関（これらの口座からの支払いがパートナーの持ち出しとして計算されます）

### スプレッドシート連携設定

- **GAS API URL**: Google Apps ScriptのWeb API URL
- **API トークン**: 認証用のトークン

## 特殊機能

### メモ欄の割合指定

取引のメモ欄に数字を入力すると、その取引に対して特別な割合計算が適用されます：

- メモ欄に数字（例: 30）を入力すると、その取引金額の指定した割合（例: 30%）がパートナーの負担額に加算されます
- これは特定の取引に対して通常の割合設定とは異なる分担比率を適用したい場合に便利です

## トラブルシューティング

- **データが表示されない場合**: MoneyForwardのページを再読み込みするか、拡張機能のポップアップで「データを更新」ボタンをクリックしてください
- **計算結果が正しくない場合**: 設定を確認し、除外カテゴリやパートナー金融機関が正しく設定されているか確認してください
- **拡張機能が動作しない場合**: Chromeの拡張機能ページで拡張機能が有効になっているか確認してください

## Google スプレッドシート連携

計算結果をスプレッドシートに保存する機能を使用するには、Google Apps Script（GAS）のセットアップが必要です。

### 1. Google スプレッドシートの準備

1. 新しい Google スプレッドシートを作成
2. スプレッドシートの名前を設定（例：「MoneyForward 経費管理」）

### 2. Apps Script の設定

1. スプレッドシートを開く
2. メニューから「拡張機能」→「Apps Script」を選択
3. 開いたスクリプトエディタに `gas/spreadsheet-api.gs` の内容をコピー＆ペースト
4. **重要**: コード内の `SECRET_TOKEN` を独自の値に変更
   ```javascript
   const SECRET_TOKEN = 'your-unique-secret-token-here';
   ```

### 3. Web アプリとしてデプロイ（API公開）

#### 初回デプロイ
1. スクリプトエディタの右上「デプロイ」→「新しいデプロイ」をクリック
2. 設定：
   - **種類**：「ウェブアプリ」を選択
   - **説明**：「MoneyForward Extension API」（任意）
   - **次のユーザーとして実行**：「自分」
   - **アクセスできるユーザー**：「全員」
     - ※「全員」を選択することでAPIとして公開されます
     - URLを知らない限りアクセスできず、トークン認証も必要なので安全です
3. 「デプロイ」をクリック
4. 初回は権限の承認画面が表示されるので承認
5. 表示される**ウェブアプリのURL**をコピー（Chrome拡張機能で使用）

#### コード更新時の再デプロイ
1. コードを修正した後、「デプロイ」→「デプロイを管理」
2. 鉛筆アイコン（編集）をクリック
3. 「バージョン」で「新バージョン」を選択
4. 「デプロイ」をクリック

#### デプロイの確認
- デプロイ後、取得したURLにブラウザでアクセスすると以下が表示されます：
  ```json
  {
    "success": true,
    "message": "MoneyForward Spreadsheet API is running",
    "version": "1.0.0"
  }
  ```

### 4. Chrome 拡張機能での設定

1. Chrome拡張機能のポップアップを開く
2. 「設定」タブを選択
3. スプレッドシート連携設定に以下を入力：
   - **GAS API URL**: デプロイ時にコピーしたURL
   - **API トークン**: GASコードで設定したSECRET_TOKEN

### データの仕様

#### スプレッドシートの形式
- **A列（Month）**: 月の日付（例：2025/10/01）
  - Chrome拡張機能から「2025/10」形式で送信されますが、スプレッドシートが自動的に月初日に変換します
- **B列（Amount）**: 金額
  - パートナー不足額の符号を反転した値が記録されます
  - プラス値：パートナーの払いすぎ（返金が必要）
  - マイナス値：パートナーの支払い不足（請求が必要）

#### 金額の符号について
- Chrome拡張機能の画面上では「パートナー不足」としてプラス値で表示される金額が、スプレッドシートにはマイナス値として記録されます
- これは、不足額を「支出」として管理するための仕様です

### テスト方法

#### Apps Script エディタでのテスト
1. `testScript` 関数を選択
2. 「実行」をクリック
3. スプレッドシートにテストデータが追加されることを確認

#### Chrome拡張機能からのテスト
1. MoneyForwardの家計簿ページを開く
2. 計算結果パネルの「スプレッドシートに保存」ボタンをクリック
3. スプレッドシートにデータが追加されることを確認

## トラブルシューティング

### 基本的な問題
- **データが表示されない場合**: MoneyForwardのページを再読み込みするか、拡張機能のポップアップで「データを更新」ボタンをクリックしてください
- **計算結果が正しくない場合**: 設定を確認し、除外カテゴリやパートナー金融機関が正しく設定されているか確認してください
- **拡張機能が動作しない場合**: Chromeの拡張機能ページで拡張機能が有効になっているか確認してください

### スプレッドシート連携の問題
- **「Invalid token」エラー**: トークンが一致していません。GASコードと拡張機能の設定を確認してください
- **「スクリプトが見つかりません」エラー**: URLが正しくコピーされているか確認してください
- **データが保存されない**: スプレッドシートの権限設定を確認してください

## 技術的な詳細

- React + TypeScriptで開発
- Viteを使用したビルドシステム
- Chrome Extension Manifest V3に対応
- コンテンツスクリプトを使用してMoneyForwardページと連携
- Google Apps ScriptによるスプレッドシートAPI連携
